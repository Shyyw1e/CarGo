# CarGo

## Бэкенд

- **Язык/фреймворк:** Go + `chi` (легкий, mid-level middleware) или `echo` (чуть быстрее на старте).
- **Структура:** один репозиторий, **модульный монолит**: `auth`, `users/kyc`, `listings`, `deals` (эскроу), `chat`, `search`, `support`.
- **Хранилище:** **PostgreSQL** (единственная БД на MVP) + **pgx**, миграции `golang-migrate`.
    - Почему без Mongo: схемы предсказуемые, транзакции важны (сделки, списания), JSONB в Postgres закрывает «гибкие» поля.
- **Кеш/события:** **Redis** (кеш профилей/листингов, Pub/Sub для чата, отложенные задачи через streams/delayed queues).
- **Файлы:** **S3-совместимое** (MinIO локально, S3/Wasabi в проде) для фото авто и вложений в спорах.
- **Поиск:**
    - MVP: **Meilisearch** (простая настройка, быстрый BM25, хорош для RU), альтернативно **OpenSearch/Elasticsearch** (если сразу нужны аггрегации/сильно кастомные скора).
    - Фасеты: марка/модель/год/пробег/страна доставки/цена/сроки/рейтинг перегонщика.
- **Рекомендации/векторка (позже):**
    - Начать с правила/скоринга + «похожие» по атрибутам.
    - Дальше: **pgvector** (в Postgres) или вектор-индекс Meilisearch/ES, гибрид BM25+вектор (RRF).
- **WebSocket** + Redis Pub/Sub; хранение сообщений в Postgres (табличка messages, индексация по deal\_id).
- **Чат:**
    - Фильтр контактов (регулярки + простая NER), модерация (см. ниже).
- **Платежи/эскроу:**
    - Провайдер с поддержкой **холда/раздельных выплат**: ЮKassa/CloudPayments (РФ), Stripe/Adyen (EU/US).
    - Состояния сделки: `created → funded(hold) → in_transit → delivered → released / disputed → resolved`.
- **Админка/поддержка:** быстрый **Retool**/Appsmith поверх REST/SQL на MVP.

## Инфраструктура

- **Запуск:** Docker Compose (Postgres, Redis, Meili, MinIO, бэкенд, фронт).
- **Kubernetes:** позже, когда появятся ≥3-5 сервисов с независимыми релизами/автоскейлом и devops-ресурс.
- **Kafka:** **не на MVP**. Появится нужда при:
    - антифроде/логировании событий (миллионы событий/день),
    - сигналинге рекомендаций/кластеризации поведения,
    - интеграции многих внешних коннекторов.
    Пока хватит Redis Streams/Sidekiq-подобной очереди.
- **Логи/метрики/трейсы:** `slog` + Loki, Prometheus + Grafana, OpenTelemetry (otlp exporter → Tempo/Jaeger).
- **CI/CD:** GitHub Actions + Docker buildx, автодеплой на VPS/Cloud Run/EC2.

## Безопасность и правовые моменты (важно)

- **KYC/идентификация перегонщиков**: минимум паспорт/права + селфи-матч. Поставщик: Sumsub/YouControl/IDnow (зависит от гео).
- **Хранение средств:** холд через лицензированного провайдера (вы **не** банк и **не** храните деньги сами).
- **AML/anti-fraud:** базовые правила (частые отмены, аномальные цены, новые аккаунты без историй → ручная проверка).
- **Юридическое предупреждение:** вы не занимаетеcь растаможкой/оформлением — это на стороне покупателя; в условиях оферты это нужно явно прописать.
*(Это не юрконсультация; лучше подключить юриста по финтех/маркетплейсам в целевых гео.)*

# Домен и схемы (скелет)

## Таблицы (Postgres)

- `users(id, role [buyer, driver], kyc_status, rating, created_at, ...)`
- `listings(id, user_id, brand, model, year, mileage, country_from, price, delivery_eta_days, photos[], attributes jsonb, status)`
- `deals(id, buyer_id, driver_id, listing_id, amount, fee, hold_payment_id, status, timeline jsonb, created_at)`
- `messages(id, deal_id, sender_id, body, redacted_body, flags jsonb, created_at)`
- `reviews(id, deal_id, reviewer_id, reviewee_id, rating, comment, created_at)`
- `search_index (внешний — Meili/ES), дублируем ключевые поля + фасеты`
- `events_audit(id, entity, entity_id, event, payload jsonb, created_at)` — на будущее (антифрод/аналитика).

Индексы: по `listings` (brand, model, price, country\_from, delivery\_eta\_days), `deals` (status, buyer\_id/driver\_id), `messages(deal_id, created_at)`.

# Чат и фильтрация контактов

**Механика:**

- На вход: чистим `phone`, `email`, `t.me/telegram/wa.me`, `@username`, `vk.com`, латентные паттерны вроде «телеграм точка me слеш ник».
- **Политика:**
    - мягкий режим: редактируем сообщение, заменяя контакты на `**` + всплывашка «обмен контактами запрещен до завершения сделки»;
    - строгий при попытках обхода: временный мут/флаг на ручную модерацию.
- **Хранилище:** сохраняем и `body`, и `redacted_body` + `flags` (например, `{contact_attempts: 2}`).

# Эскроу/статусы сделки (детализация)

1. `created` — инициировано, счет выставлен.
2. `funded` — холд прошёл (webhook провайдера).
3. `in_transit` — перегонщик подтвердил старт.
4. `delivered` — покупатель подтвердил получение.
5. `released` — автосписание продавцу (минус комиссия).
6. `disputed` — спор: заморозить, открыть тикет, дать окну на вложения.
7. `resolved_refund|resolved_release` — финал.

**Комиссия:** % от суммы + минимальный фикс. Логируйте финмодель в `events_audit`.

# Поиск и рекомендации

## Поиск (MVP)

- **Meilisearch**: документы `listing` с фасетами.
- Сортировка: по `score` (BM25) + буст по свежести объявления + рейтинг перегонщика + вероятность завершения сделки (эвристика).
- Синонимы/нормализация: «джип»→SUV, «подвеска мягкая/жёсткая» → словарь атрибутов.

## Рекомендации (поэтапно)

1. **Правила + коллаборативные эвристики:** «похожие объявления», «другие заказы этого перегонщика», «популярное в выбранной стране/коридоре доставки».
2. **Фичи поведения:** клики, добавление в избранное, чат-инициации, досмотры карточек → re-rank.
3. **Векторка:** описания авто и пользовательский запрос → эмбеддинги (pgvector). Гибрид: RRF(BM25, Vector, Freshness).
4. **Anti-bias:** следите за диверсификацией выдачи (не замыкать на 2-3 перегонщиках).

# ИИ-ассистент (навигация + подбор)

## Навигатор (как «Макс» на Госуслугах)

- **RAG** поверх базы знаний: FAQ, правила сделки, комиссии, статусы, KYC, как открыть спор.
- Индекс: md/faq → векторный индекс (pgvector или локальный Qdrant) + BM25 (Meili).
- Оркестрация: роутер «вопрос/навигация» vs «подбор авто».
- **Guardrails:** не давать юрсоветы; редактировать ответы до «информационных».

## ИИ-подбор авто

- **Парсер запроса** → критерии (дорожные условия, бюджет, стиль/класс).
- **Фильтр/перевод в фасеты** → запрос в поиск (BM25+вектор).
- **Реренк** с учётом CTR, рейтинга перегонщика, срока доставки.
- **Объяснения выбора** (why-explanations) — повышают доверие.

> На MVP можно использовать локальные эмбеддинги (например, bge-small-ru) + простую rerank-модель; большие LLM держать не обязательно — можно дергать облачные API, если вопрос стоимости решаем.
> 

# Антифрод/модерация

- **Сигналы риска:** новый аккаунт, много чатов без сделок, часто оспаривает, цена сильно ниже рынка, аномальные маршруты.
- **Правила:** очки риска → ручная проверка/лимиты (максимальная сумма сделки до прохождения полного KYC).
- **Модерация контента:** запрещенные слова/фото (элементарный классификатор + флаги).

# Набор библиотек (Go)

- HTTP: `chi` + `chi/middleware`.
- DB: `pgx`, `sqlc` или `gorm` (я бы взял `sqlc` для типобезопасности).
- Миграции: `golang-migrate`.
- WebSockets: `gorilla/websocket` или `nhooyr.io/websocket`.
- Кеш/очередь: `redis/go-redis/v9`.
- Логи: `slog` (+ handler для Loki), `otel` для трассировок.
- Валидация: `go-playground/validator`.
- Конфиг: `spf13/viper` или `envconfig`.
- Тесты: `testify`, для http — `httptest`, для интеграций — `dockertest`.

# План по этапам (6–10 недель MVP)

1. **Неделя 1–2:** аутентификация, модель пользователей, объявления (CRUD), загрузка фото (S3), индексация в Meili, базовый поиск/фасеты.
2. **Неделя 3:** чат (WS + фильтр контактов + хранение), профили/рейтинги.
3. **Неделя 4:** интеграция платежного шлюза: создание платежа/холда, webhooks, статусы сделок.
4. **Неделя 5:** админка (Retool), споры, блокировки, ревью.
5. **Неделя 6:** ИИ-ассистент-навигатор (RAG по FAQ).
6. **Неделя 7–8:** ИИ-подбор авто (парсинг запроса → фильтры → гибрид-поиск), первые рекомендации.
7. **Неделя 9–10:** нагрузочные тесты, базовый антифрод, логирование/метрики, бета.

# Ответы на твои вопросы коротко

- **Стек рабочий?** Да: Go + Postgres + Redis + Meili + S3 — отличное ядро для MVP маркетплейса.
- **Kafka?** Нужна, когда вырастет событийка/антифрод/аналитика. На старте — **лишний оверхед**.
- **Mongo?** Не нужна. Postgres покрывает всё, JSONB — если «гибко».
- **Kubernetes?** Рано. Compose/1-2 VM достаточно.
- **ИИ-ассистент и подбор?** Делай по RAG + гибридному поиску, эмбеддинги локально, без тяжелой LLM на старте.

# Риски/узкие места (и как их снять)

- **Юридика эскроу и KYC:** сразу выбирайте провайдера с холдом и split-payments, проверьте доступность в целевых гео.
- **Чат-обход контактов:** комбинируйте маскирование + санкции + «почему это важно» — UX-объяснения снижают желание обойти.
- **Доверие к перегонщикам:** рейтинги, бейджи KYC, залог/страхование (доп-опция).
- **Холодный старт рекомендаций:** ручные подборки/редактура + правила → собирайте поведенческие фичи с первого дня.

---

Если хочешь, на следующем шаге накину:

- минимальную ER-диаграмму,
- схемы индексов Meili (какие поля фасетировать/весить),
- каркас endpoints (REST) по доменам,
- и черновик webhook-флоу для платежей (холд/релиз/рефанд).
